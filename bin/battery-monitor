#!/bin/bash

SCRIPT_PATH=$(readlink "${BASH_SOURCE[0]}")
if [ -z "$SCRIPT_PATH" ]; then
  SCRIPT_PATH="${BASH_SOURCE[0]}"
fi
SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
LOCK_FILE="/tmp/${SCRIPT_NAME}.lock"

if [ -z "$BATTERY_MONITOR_LOCKED" ]; then
    touch "${LOCK_FILE}"
    export BATTERY_MONITOR_LOCKED="${LOCK_FILE}"
    exec flock -x -n -o "${LOCK_FILE}" -c "${SCRIPT_PATH}"
    exit $?
fi

battery_level() {
    status="$(cat /sys/class/power_supply/BAT0/status)"
    capacity="$(cat /sys/class/power_supply/BAT0/capacity)"
    if [ "$status" = Discharging -a "$capacity" -lt 5 ]; then
        echo "EMPTY"
    elif [ "$status" = Discharging -a "$capacity" -lt 15 ]; then
        echo "LOW"
    else
        echo "OK"
    fi
}

EMPTY_MAX_TIMES=30
EMPTY_TIMES=0
LOW_TIMES=0
OK_TIMES=0

while [ true ]; do
    BATTERY_LEVEL=$(battery_level)
    case $BATTERY_LEVEL in
        EMPTY)
            let EMPTY_TIMES+=1
            LOW_TIMES=0
            OK_TIMES=0
            DELAY_SECONDS=1
            EMPTY_MAX_TIMES=30
            if [ $EMPTY_TIMES -ge ${EMPTY_MAX_TIMES} ]; then
                ~/bin/tty-ctl lock &
                systemctl hibernate
            fi
            ALERT_LEVEL="critical"
            ALERT_TITLE="Battery Empty"
            ALERT_DESCRIPTION="hibernate after $(( $EMPTY_MAX_TIMES - $EMPTY_TIMES )) seconds ..."
            ALERT_ICON="battery-empty"
            ALERT_TIMEOUT=1000
            ;;
        LOW)
            let LOW_TIMES+=1
            EMPTY_TIMES=0
            OK_TIMES=0
            DELAY_SECONDS=60
            ALERT_LEVEL="critical"
            ALERT_TITLE="Battery Low"
            ALERT_DESCRIPTION="please charging ..."
            ALERT_ICON="battery-low"
            ALERT_TIMEOUT=10000
            ;;
        *)
            let OK_TIMES+=1
            EMPTY_TIMES=0
            LOW_TIMES=0
            DELAY_SECONDS=300
            ALERT_LEVEL=
            ;;
    esac
    if [ -n "$ALERT_LEVEL" ]; then
        echo "${ALERT_TITLE}, ${ALERT_DESCRIPTION}" | wall
        if pgrep -x i3 >/dev/null 2>&1; then
            i3-msg exec "notify-send -u ${ALERT_LEVEL} -t ${ALERT_TIMEOUT} -i ${ALERT_ICON} '${ALERT_TITLE}' '${ALERT_DESCRIPTION}'"
        fi
    fi
    sleep $DELAY_SECONDS
done
