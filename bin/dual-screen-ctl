#!/bin/bash

if [ -z "$DISPLAY" ]; then
  export DISPLAY=$(~/bin/tty-ctl graphic-display)
fi

primary() {
  xrandr | grep ' connected' | awk '{print $1}' | sed -n 1p
}

secondary() {
  xrandr | grep ' connected' | awk '{print $1}' | sed -n 2p
}

list() {
  xrandr | grep ' connected' | awk '{print $1}'
}

monitor() {
  SCRIPT_PATH=$(readlink "${BASH_SOURCE[0]}")
  if [ -z "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="${BASH_SOURCE[0]}"
  fi
  SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
  LOCK_FILE="/tmp/${SCRIPT_NAME}.lock"

  if [ -z "$DUAL_SCREEN_MONITOR_LOCKED" ]; then
    touch "${LOCK_FILE}"
    export DUAL_SCREEN_MONITOR_LOCKED="${LOCK_FILE}"
    exec flock -x -n -o "${LOCK_FILE}" -c "${SCRIPT_PATH} monitor"
    exit $?
  fi
  srandrd -n ~/bin/dual-screen-ctl apply
}

apply() {
  PRIMARY=$(primary)
  SECONDARY=$(secondary)
  if [ -z "${SECONDARY}" ]; then
    xrandr --output "${PRIMARY}" --auto
  else
    xrandr --output "${PRIMARY}" --auto --output "${SECONDARY}" --auto --same-as "${PRIMARY}"
  fi
}

case "${1}" in
  list)
    list
    ;;
  primary)
    primary
    ;;
  secondary)
    secondary
    ;;
  monitor)
    monitor
    ;;
  apply)
    apply
    ;;
  *)
    echo -e "usage: ${0} <list|primary|secondary|monitor>\n\n\tlist         List srceens.\n\tprimary      Get primary srceen.\n\tsecondary    Get secondary screen.\n\tmonitor      Monitor screen plugged or unplugged." >/dev/stderr
    exit 1
    ;;
esac
