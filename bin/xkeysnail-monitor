#!/bin/bash

SCRIPT_NAME=$(basename "${BASH_SOURCE[0]}")
SCRIPT_PATH_MD5=$(echo -n "${BASH_SOURCE[0]}" | md5sum | awk '{print $1}')
SCRIPT_LOCK_FILE="/tmp/${SCRIPT_NAME}.${SCRIPT_PATH_MD5}.lock"

if [ -z "$FLOCK" ]; then
    export FLOCK=1
    touch "${SCRIPT_LOCK_FILE}"
    exec flock -x -n "${SCRIPT_LOCK_FILE}" -c "${BASH_SOURCE[0]}"
    exit $?
fi

while [ true ]; do
    if ~/bin/xkeysnail-ctl activable >/dev/null 2>&1 ; then
        if ! ~/bin/xkeysnail-ctl status >/dev/null 2>&1 ; then
            sleep 0.2
            echo -e "`date`\tStart xkeysnail"
            ~/bin/keymap-ctl stop
            ~/bin/xkeysnail-ctl start
        fi
    elif ~/bin/xkeysnail-ctl status >/dev/null 2>&1 ; then
        echo -e "`date`\tStop xkeysnail"
        ~/bin/xkeysnail-ctl stop
        ~/bin/keymap-ctl start
    fi

    if ! inotifywait -q -e modify /sys/class/tty/tty0/active >/dev/null 2>&1 ; then
        echo -e "`date`\tinotifywait failed: $?" >/dev/stderr
        sleep 10
    fi
done
