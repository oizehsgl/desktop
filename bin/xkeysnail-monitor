#!/bin/bash

SCRIPT_PATH=$(readlink "${BASH_SOURCE[0]}")
if [ -z "$SCRIPT_PATH" ]; then
  SCRIPT_PATH="${BASH_SOURCE[0]}"
fi
SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
LOCK_FILE="/tmp/${SCRIPT_NAME}.lock"
LOG_FILE="${LOG_FILE:-/dev/null}"

if [ -z "$XKEYSNAIL_MONITOR_LOCKED" ]; then
  # Modify LOCK_FILE for wakeup xkeysnail-monitor
  echo -e "$(date)\tWakeup xkeysnail-monitor" | tee ${LOCK_FILE} >>${LOG_FILE}
  export XKEYSNAIL_MONITOR_LOCKED="${LOCK_FILE}"
  exec flock -x -n "${LOCK_FILE}" -c "${SCRIPT_PATH}"
  exit $?
fi

capslock_off() {
  # setcapslock will crash with core in Non-X environments, avoid it.
  if [ -n "$DISPLAY" ]; then
    setcapslock off
  fi
  setleds -caps
  echo -e "$(date)\tCapsLock off" >>${LOG_FILE}
}

while [ true ]; do
  if [ "$(~/bin/tty-ctl graphic)" = "$(~/bin/tty-ctl active)" ]; then
    # Startup xkeysnail instantly after switch to X desktop may freeze desktop,
    # delay startup xkeysnail for rescue.
    sleep 0.2
    if [ "$(~/bin/tty-ctl graphic)" = "$(~/bin/tty-ctl active)" ]; then
      if ~/bin/keymap-ctl status >/dev/null 2>&1; then
        ~/bin/keymap-ctl stop
        echo -e "$(date)\tStop keymap" >>${LOG_FILE}
      fi
      if ! ~/bin/xkeysnail-ctl status >/dev/null 2>&1; then
        echo -e "$(date)\tStart xkeysnail" >>${LOG_FILE}
        ~/bin/xkeysnail-ctl start
      fi
    fi
  else
    if ~/bin/xkeysnail-ctl status >/dev/null 2>&1; then
      echo -e "$(date)\tStop xkeysnail" >>${LOG_FILE}
      ~/bin/xkeysnail-ctl stop
    fi
    if ! ~/bin/keymap-ctl status >/dev/null 2>&1; then
      echo -e "$(date)\tStart keymap" >>${LOG_FILE}
      ~/bin/keymap-ctl start
    fi
  fi

  capslock_off

  TTY_ACTIVE_CURRENT=$(cat /sys/class/tty/tty0/active)
  if [ "${TTY_ACTIVE_PREVIOUS}" = "${TTY_ACTIVE_CURRENT}" ]; then
    if ! inotifywait -q -e modify /sys/class/tty/tty0/active "${LOCK_FILE}" >/dev/null 2>&1; then
      echo -e "$(date)\tinotifywait failed: $?" >>${LOG_FILE}
      sleep 10
    fi
  fi
  TTY_ACTIVE_PREVIOUS=${TTY_ACTIVE_CURRENT}
  echo -e "$(date)\tinotifywait successed" >>${LOG_FILE}
done
