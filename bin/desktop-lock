#!/bin/bash

REASON="$1"

# Use i3lock of i3.
if [ "$XDG_CURRENT_DESKTOP" = "i3" ]; then
    if [ "$REASON" = "auto" ]; then
       EMACS_PID="`pidof emacs | awk '{print $1}'`"
       if [ -n "$EMACS_PID" ]; then
           if ! grep -a -E "XDG_VTNR=${XDG_VTNR}[^\\d]" /proc/${EMACS_PID}/environ >/dev/null 2>&1; then
               if [ "${XDG_VTNR}" != "`~/bin/tty-ctl active`" ]; then
                   # Disable i3 auto lock, emacs running on other tty will did this for us.
                   exit 1
               fi
           fi
       fi
    fi

    revert() {
        xset dpms 0 0 0
    }
    trap revert HUP INT TERM

    if false; then
        # screen delay close
        xset +dpms dpms 5 5 5
    else
        # fallback if screen delay close not works
        (sleep 1; xset dpms force off) &
    fi

    i3lock-fancy -n -f Source-Code-Pro -t '' -gp
    revert
    exit 0
fi

# Use tty lock otherwise.
~/bin/tty-ctl lock
exit 0
