#!/bin/bash

REASON="$1"

i3_lock() {
    revert() {
        xset dpms 0 0 0
    }
    trap revert HUP INT TERM

    if false; then
        # screen delay close
        xset +dpms dpms 5 5 5
    else
        # fallback if screen delay close not works
        (sleep 1; xset dpms force off) &
    fi

    i3lock-fancy -n -f Source-Code-Pro -t '' -gp
    revert
}

tty_lock() {
    ~/bin/tty-ctl lock
}

# Use i3lock if i3 is active, tty lock otherwise.
TTY_I3=$(~/bin/i3-ctl tty)
TTY_ACTIVE=$(~/bin/tty-ctl active)
if [ "${TTY_I3}" = "${TTY_ACTIVE}" ]; then
    if [ "${XDG_VTNR}" != "${TTY_I3}" ]; then
        i3-msg exec ~/bin/desktop-lock $REASON
    else
        i3_lock
    fi
else
    tty_lock
fi
